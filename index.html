<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="js/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>QR Code Scanner</h1>
  </header>

  <main>
    <div id="reader-container">
      <div id="reader"></div>
    </div>
    <div id="zoomControl">
      <label for="zoomSlider">Zoom:</label>
      <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" />
    </div>
    <p id="status">Initializing scanner...</p>

    <section id="register-section" style="display: none;">
      <p class="success-text">QR Code Verified</p>
      
      <!-- Face Capture Section -->
      <div id="face-capture-container">
        <video id="faceVideo" autoplay playsinline></video>
        <canvas id="faceCanvas" style="display: none;"></canvas>
        <p id="face-status">Position your face in the frame</p>
      </div>
      
      <input type="text" id="registerNumber" placeholder="Enter Register Number">
      <button id="getCodeBtn" onclick="submitRegisterNumber()">Submit Attendance</button>
      <p id="loadingMessage" style="display:none;">Verifying face and processing attendance...</p>
      <p id="code-result"></p>
      <p id="face-verification-status"></p>
    </section>
  </main>

  <script>
    const baseText = "jaycavbhakanadiyaz";
    const apiEndpoint = "https://sorry-no-proxy-pro.onrender.com/register";
    const verifyEndpoint = "https://sorry-no-proxy-pro.onrender.com/verify-face";
    const formUrl = "YOUR_GOOGLE_FORM_URL_HERE"; // Set your Google Form URL

    let html5QrCode;
    let qrScanned = false;
    let videoTrack = null;
    let faceStream = null;
    let faceVideo = null;
    let faceCanvas = null;

    function getCurrentTimeFormats() {
      const now = new Date();
      const currentHour = String(now.getHours()).padStart(2, '0');
      const currentMinute = String(now.getMinutes()).padStart(2, '0');
      
      const validFormats = [];
      
      // Current time: {HH}{MM}
      validFormats.push(baseText + currentHour + currentMinute);
      
      // Next 4 minutes: {HH}{MM+01}, {HH}{MM+02}, {HH}{MM+03}, {HH}{MM+04}
      for (let i = 1; i <= 4; i++) {
        const futureTime = new Date(now.getTime() + i * 60000); // Add i minutes
        const futureHour = String(futureTime.getHours()).padStart(2, '0');
        const futureMinute = String(futureTime.getMinutes()).padStart(2, '0');
        validFormats.push(baseText + futureHour + futureMinute);
      }
      
      // Debug: Log current time and valid formats
      console.log('Current time:', currentHour + ':' + currentMinute);
      console.log('Valid QR formats:', validFormats);
      
      return validFormats;
    }

    function isValidQRCode(decodedText) {
      const validFormats = getCurrentTimeFormats();
      const isValid = validFormats.includes(decodedText);
      
      // Debug: Log scanned QR and validation result
      console.log('Scanned QR:', decodedText);
      console.log('Is valid:', isValid);
      
      return isValid;
    }

    async function initializeScanner() {
      html5QrCode = new Html5Qrcode("reader");

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras.length) {
          document.getElementById("status").innerText = "No camera found.";
          return;
        }

        const backCamera = cameras.find(cam => cam.label.toLowerCase().includes("back")) || cameras[0];

        await html5QrCode.start(
          backCamera.id,
          {
            fps: 10,
            videoConstraints: { facingMode: "environment" }
          },
          onScanSuccess,
          onScanFailure
        );

        document.getElementById("status").innerText = "Point your phone close to the QR";

        const interval = setInterval(() => {
          const videoElem = document.querySelector("video");
          const stream = videoElem?.srcObject;
          if (videoElem && stream) {
            clearInterval(interval);
            videoTrack = stream.getVideoTracks()[0];
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.zoom) {
              const zoomSlider = document.getElementById("zoomSlider");
              zoomSlider.min = capabilities.zoom.min || 1;
              zoomSlider.max = capabilities.zoom.max || 5;
              zoomSlider.step = 0.1;
              zoomSlider.value = capabilities.zoom.min || 1;

              document.getElementById("zoomControl").style.display = "block";

              zoomSlider.addEventListener("input", async (e) => {
                const newZoom = parseFloat(e.target.value);
                try {
                  await videoTrack.applyConstraints({
                    advanced: [{ zoom: newZoom }]
                  });
                } catch (err) {
                  console.warn("Zoom failed:", err);
                }
              });
            }
          }
        }, 300);

      } catch (err) {
        document.getElementById("status").innerText = `Error: ${err.message}`;
      }
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(console.error);
      }
    }

    function onScanSuccess(decodedText) {
      if (!qrScanned && isValidQRCode(decodedText)) {
        qrScanned = true;
        document.getElementById("status").innerText = "QR Verified.";
        document.getElementById("reader").style.display = "none";
        document.getElementById("zoomControl").style.display = "none";
        document.getElementById("register-section").style.display = "block";
        stopScanner();
        initializeFaceCapture();
      } else {
        document.getElementById("status").innerText = "Invalid QR. Try again.";
      }
    }

    async function initializeFaceCapture() {
      faceVideo = document.getElementById("faceVideo");
      faceCanvas = document.getElementById("faceCanvas");
      
      try {
        // Access front-facing camera for face capture
        faceStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "user", // Front camera
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        });
        
        faceVideo.srcObject = faceStream;
        document.getElementById("face-status").innerText = "Face detected. Enter your registration number.";
      } catch (error) {
        console.error("Error accessing camera:", error);
        document.getElementById("face-status").innerText = "Camera access denied. Please allow camera access.";
        document.getElementById("face-status").style.color = "#d32f2f";
      }
    }

    function captureFaceImage() {
      if (!faceVideo || !faceCanvas) {
        return null;
      }
      
      const video = faceVideo;
      const canvas = faceCanvas;
      
      // Set canvas dimensions to match video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Draw current video frame to canvas
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Convert to base64
      return canvas.toDataURL("image/jpeg", 0.8);
    }

    function stopFaceCapture() {
      if (faceStream) {
        faceStream.getTracks().forEach(track => track.stop());
        faceStream = null;
      }
    }

    function onScanFailure(error) {
      console.warn("Scan error:", error);
    }

    async function submitRegisterNumber() {
      const reg = document.getElementById("registerNumber").value.trim();
      const loading = document.getElementById("loadingMessage");
      const result = document.getElementById("code-result");
      const btn = document.getElementById("getCodeBtn");
      const faceStatus = document.getElementById("face-verification-status");

      if (!reg) {
        alert("Please enter your registration number.");
        return;
      }

      // Capture face image
      const faceImage = captureFaceImage();
      if (!faceImage) {
        alert("Unable to capture face. Please ensure camera is working.");
        return;
      }

      btn.style.display = "none";
      loading.style.display = "block";
      result.innerText = "";
      faceStatus.innerText = "";
      result.style.color = "#388e3c";

      try {
        // First verify the face
        faceStatus.innerText = "Verifying face...";
        faceStatus.style.color = "#f57c00";
        
        const verifyRes = await fetch(verifyEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            registerNumber: reg,
            faceImage: faceImage 
          })
        });

        const verifyData = await verifyRes.json();

        if (!verifyData.verified) {
          faceStatus.innerText = `Face verification failed: ${verifyData.message || "Face does not match registration number"}`;
          faceStatus.style.color = "#d32f2f";
          loading.style.display = "none";
          btn.style.display = "block";
          return;
        }

        // Face verified, proceed with registration
        faceStatus.innerText = "Face verified! Submitting attendance...";
        faceStatus.style.color = "#2e7d32";

        const res = await fetch(apiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            registerNumber: reg,
            faceImage: faceImage 
          })
        });

        const data = await res.json();

        if (data.success) {
          // Stop face capture
          stopFaceCapture();
          
          // Show success
          if (data.code) {
            result.innerText = `Success! Your code: ${data.code}. Redirecting...`;
          } else {
            result.innerText = `Success! Redirecting...`;
          }
          faceStatus.innerText = "Attendance recorded successfully!";
          faceStatus.style.color = "#2e7d32";

          // Redirect after short delay
          const destination = (typeof formUrl === "string" && formUrl.startsWith("http")) ? formUrl : null;
          if (destination) {
            setTimeout(() => {
              window.location.href = destination;
            }, 3000);
          } else {
            result.innerText += ` (Form URL not set)`;
          }
        } else {
          alert(data.message || "Registration failed.");
          btn.style.display = "block";
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Server error. Please try again.");
        btn.style.display = "block";
      } finally {
        loading.style.display = "none";
      }
    }

    window.addEventListener("load", initializeScanner);
  </script>
</body>
</html>
